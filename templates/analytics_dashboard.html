{% extends 'base.html' %}

{% block title %}Analytics Dashboard - Radiology AI{% endblock %}
{% block page_title %}Analytics{% endblock %}

{% block authenticated_content %}
<!-- Analytics Header -->
<div class="dashboard-header">
    <h1><i class="bi bi-bar-chart-fill"></i> Analytics Dashboard</h1>
    <p class="dashboard-subtitle">Comprehensive Performance & Activity Insights</p>
</div>

<div class="row mb-4">
    <!-- Profile Summary Card -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="user-avatar-large mb-3">
                    {% if request.session.user_role == 'admin' %}üë®‚Äçüíº
                    {% elif request.session.user_role == 'radiologist' %}üë®‚Äç‚öïÔ∏è
                    {% else %}üë®‚Äçüîß{% endif %}
                </div>
                <h5 class="card-title">{{ request.session.user_name|default:"User" }}</h5>
                <p class="text-muted">{{ request.session.user_email|default:"user@hospital.com" }}</p>
                <span class="badge bg-primary">{{ request.session.user_role|default:"technician"|title }}</span>
                <div class="mt-3">
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Completion Progress Card -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="bi bi-pie-chart"></i> Report Completion</h6>
            </div>
            <div class="card-body text-center">
                <div class="progress-circle-wrapper">
                    <div class="progress-circle" data-percentage="{{ completion_percentage|default:75 }}">
                        <span class="progress-text">{{ completion_percentage|default:75|floatformat:0 }}%</span>
                    </div>
                </div>
                <p class="mt-3 mb-0">
                    <strong>{{ completed_scans|default:45 }}</strong> of <strong>{{ total_scans|default:60 }}</strong> scans completed
                </p>
            </div>
        </div>
    </div>
    
    <!-- Quick Stats Card -->
    <div class="col-lg-4 col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="bi bi-speedometer2"></i> Quick Overview</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-value text-success">{{ avg_processing_time|default:2.4|floatformat:1 }}h</div>
                            <div class="stat-label">Avg Time</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-value text-info">{{ pending_scans|default:8 }}</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Analytics Cards -->
<div class="row mb-4">
    <!-- Performance Metrics -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <i class="stats-card-icon bi bi-file-earmark-medical text-primary"></i>
            <div class="stats-card-value">{{ total_scans|default:60 }}</div>
            <div class="stats-card-label">Total Scans</div>
            <div class="stats-card-change positive">
                <i class="bi bi-arrow-up"></i>
                Total processed
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <i class="stats-card-icon bi bi-check-circle text-success"></i>
            <div class="stats-card-value">{{ completed_scans|default:45 }}</div>
            <div class="stats-card-label">Completed</div>
            <div class="stats-card-change positive">
                <i class="bi bi-arrow-up"></i>
                Reports done
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <i class="stats-card-icon bi bi-hourglass-split text-warning"></i>
            <div class="stats-card-value">{{ pending_scans|default:8 }}</div>
            <div class="stats-card-label">Pending</div>
            <div class="stats-card-change">
                <i class="bi bi-dash"></i>
                In progress
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <i class="stats-card-icon bi bi-graph-up text-info"></i>
            <div class="stats-card-value">95%</div>
            <div class="stats-card-label">Accuracy</div>
            <div class="stats-card-change positive">
                <i class="bi bi-arrow-up"></i>
                AI Confidence
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Daily Activity Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="bi bi-calendar3"></i> Daily Scan Activity (Last 30 Days)</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="dailyScansChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scan Type Distribution -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="bi bi-pie-chart-fill"></i> Scan Types</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="scanTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="bi bi-graph-up"></i> Weekly Performance Overview</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workload Chart (Admin/Radiologist only) -->
{% if request.session.user_role == 'admin' or request.session.user_role == 'radiologist' %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="bi bi-people-fill"></i> Team Workload Distribution</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="workloadChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Activity Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="bi bi-clock-history"></i> Recent Activity</h6>
            </div>
            <div class="card-body">
                {% if recent_scans %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Patient Name</th>
                                <th>Scan Type</th>
                                <th>Uploaded By</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for scan in recent_scans %}
                            <tr>
                                <td><i class="bi bi-person-fill text-muted me-2"></i>{{ scan.patient_name }}</td>
                                <td><span class="badge bg-info">{{ scan.scan_type }}</span></td>
                                <td><small class="text-muted">{{ scan.uploaded_by }}</small></td>
                                <td><small class="text-muted">{{ scan.uploaded_at|date:"M d, Y" }}</small></td>
                                <td>
                                    {% if scan.status == 'Completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif scan.status == 'Under Review' %}
                                        <span class="badge bg-info">Under Review</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'analyze_scan' scan.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">No recent activity</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Additional Styling -->
<style>
.user-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--accent-secondary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto;
}

.progress-circle-wrapper {
    position: relative;
    display: inline-block;
    margin: 1rem 0;
}

.progress-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: conic-gradient(var(--accent-secondary) 0deg, var(--accent-secondary) calc(var(--percentage) * 3.6deg), var(--border-primary) calc(var(--percentage) * 3.6deg), var(--border-primary) 360deg);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.progress-circle::before {
    content: '';
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: var(--bg-secondary);
    position: absolute;
}

.progress-text {
    position: relative;
    z-index: 1;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-item {
    padding: 0.5rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.chart-container canvas {
    max-height: 300px !important;
}
</style>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Set progress circle percentage
document.addEventListener('DOMContentLoaded', function() {
    const progressCircle = document.querySelector('.progress-circle');
    if (progressCircle) {
        const percentage = progressCircle.dataset.percentage || 0;
        progressCircle.style.setProperty('--percentage', percentage);
    }
});

// Chart.js Configuration with Professional Theme
Chart.defaults.color = '#64748B';
Chart.defaults.borderColor = '#E2E8F0';
Chart.defaults.font.family = 'Inter, system-ui, sans-serif';

// Mock data for demonstration - replace with actual API calls
const mockData = {
    dailyScans: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        data: [12, 19, 8, 15, 10, 14, 7]
    },
    scanTypes: {
        labels: ['X-Ray', 'CT Scan', 'MRI', 'Ultrasound'],
        data: [45, 30, 15, 10]
    },
    performance: {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        completed: [20, 25, 30, 28],
        pending: [5, 3, 2, 4]
    }
};

// Daily Scans Chart
const dailyCtx = document.getElementById('dailyScansChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: mockData.dailyScans.labels,
        datasets: [{
            label: 'Scans Processed',
            data: mockData.dailyScans.data,
            borderColor: '#1E40AF',
            backgroundColor: 'rgba(30, 64, 175, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 5 } } }
    }
});

// Scan Type Chart
const typeCtx = document.getElementById('scanTypeChart').getContext('2d');
new Chart(typeCtx, {
    type: 'doughnut',
    data: {
        labels: mockData.scanTypes.labels,
        datasets: [{
            data: mockData.scanTypes.data,
            backgroundColor: ['#1E40AF', '#0EA5E9', '#10B981', '#F59E0B'],
            borderWidth: 2,
            borderColor: '#FFFFFF'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
    }
});

// Performance Chart
const perfCtx = document.getElementById('performanceChart').getContext('2d');
new Chart(perfCtx, {
    type: 'bar',
    data: {
        labels: mockData.performance.labels,
        datasets: [
            {
                label: 'Completed',
                data: mockData.performance.completed,
                backgroundColor: '#10B981',
                borderRadius: 4
            },
            {
                label: 'Pending',
                data: mockData.performance.pending,
                backgroundColor: '#F59E0B',
                borderRadius: 4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 5 } } }
    }
});

</script>

{% if request.session.user_role == 'admin' or request.session.user_role == 'radiologist' %}
<script>
// Workload Chart for Admin and Radiologist
const workloadCtx = document.getElementById('workloadChart').getContext('2d');
new Chart(workloadCtx, {
    type: 'bar',
    data: {
        labels: ['Dr. Smith', 'Dr. Johnson', 'Dr. Williams', 'Dr. Brown', 'Dr. Davis'],
        datasets: [{
            label: 'Completed Scans',
            data: [25, 22, 18, 16, 12],
            backgroundColor: '#1E40AF',
            borderRadius: 4
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true, ticks: { stepSize: 5 } } }
    }
});
</script>
{% endif %}
{% endblock %}